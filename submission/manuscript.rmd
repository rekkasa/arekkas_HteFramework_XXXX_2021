---
title: "A standardized framework for risk-based assessment of treatment effect heterogeneity in observational healthcare databases"
author: 
  - Alexandros Rekkas, MSc${^1}$ 
  - David van Klaveren, PhD$^{2,3}$, 
  - Patrick B. Ryan, PhD$^4$
  - Ewout W. Steyerberg, PhD$^{3,5}$
  - David M. Kent, PhD$^2$
  - Peter R. Rijnbeek, PhD${^1}$
output:
    bookdown::pdf_document2: default
    bookdown::word_document2:
        reference_docx: reference.docx
geometry: margin=1.0in
toc: false
font-size: 11pt
header-includes:
  - \renewcommand*\familydefault{\sfdefault}
  - \usepackage{setspace}
  - \doublespacing
  - \usepackage[left, pagewise]{lineno}
  - \usepackage{caption}
editor_options: 
  chunk_output_type: console
bibliography: references.bib
csl: jamia.csl
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(here)
library(kableExtra)
d <- function(x, decimals = 2) {
  sprintf(paste0("%1.", decimals, "f"), x) 
}
inline_hook <- function(x) {
  if (is.numeric(x)) {
    if (abs(x - round(x)) < .Machine$double.eps) {
      formatted <- format(x, digits = 1, big.mark = ",")
    } else {
      formatted <- format(x, digits = 1 ,nsmall = 2, big.mark = ",")
    }
  } else {
    formatted <- x
  }
  
  return(formatted)
}

knit_hooks$set(inline = inline_hook)
```
\thispagestyle{empty}
\vspace{8mm}

$^1$ Department of Medical Informatics, Erasmus University Medical Center,
Rotterdam, Netherlands

$^2$ Predictive Analytics and Comparative Effectiveness (PACE) Center, Institute
for Clinical Research and Health Policy Studies (ICRHPS), Tufts Medical Center,
Boston, MA, USA

$^3$ Department of Public Health, Erasmus University Medical Center, Rotterdam,
Netherlands

$^4$ Janssen Research and Development, 125 Trenton Harbourton Rd,
Titusville,NJ 08560, USA

$^5$ Department of Biomedical Data Sciences, Leiden University Medical Center,
Leiden, The Netherlands


\vspace{10mm}
**Corresponding author**
\singlespacing 
Alexandros Rekkas, MSc

Department of Medical Informatics

Erasmus University Medical Center

3000 CA Rotterdam, P.O. Box 2040

Email: a.rekkas@erasmusmc.nl
\onehalfspacing

\vspace{10mm}
**Funding**

This work has been performed in the European Health Data and
Evidence Network (EHDEN) project. This project has received funding from the
Innovative Medicines Initiative 2 Joint Undertaking (JU) under grant agreement
No 806968. The JU receives support from the European Union’s Horizon 2020
research and innovation programme and EFPIA.

\newpage
\newpage
# Abstract {-}
\singlespacing 
One of the aims of the Observational Health Data Sciences and Informatics
(OHDSI) initiative is population-level treatment effect estimation in large
observational databases. Since treatment effects are well-known to vary across
groups of patients with different baseline risk, we aimed to extend the OHDSI
library of open-source tools with a framework for risk-based assessment of
treatment effect heterogeneity. The proposed framework consists of five
steps: 1) definition of the problem, i.e. the population, the treatment, the
comparator and the outcome(s) of interest; 2) identification of relevant
databases; 3) development of a prediction model for the outcome(s) of
interest; 4) estimation of relative and absolute treatment effect within strata
of predicted risk, after adjusting for observed confounding; 5) presentation of
the results. We demonstrate our framework by evaluating heterogeneity of the
effect of angiotensin-converting enzyme (ACE) inhibitors versus beta blockers on
3 efficacy and 6 safety outcomes across three observational databases. Patients
    at low risk of acute myocardial infarction (MI) received negligible absolute
benefits for all 3 efficacy outcomes, though they were more pronounced in the
highest risk quarter, especially for hospitalization with heart failure. The
substantial risk increase of cough and angioedema with ACE inhibitors across all
risk strata suggests that beta blockers provide a viable alternative to patients
at low risk of acute MI. The proof of concept study demonstrates its feasibility
in large observational data. Further insights may arise by application to safety
and effectiveness questions across the global data network.

\vspace{10mm}

**Keywords**: observational data, heterogeneity of treatment effect, risk stratification, subgroup analysis
\newpage 
\doublespacing 
\linenumbers

# Introduction

The Observational Health Data Science and Informatics (OHDSI) collaborative has
established a global network of data partners and researchers that aim to bring
out the value of health data through large-scale analytics by mapping local
databases to the Observational Medical Outcomes Partnership (OMOP) Common Data
Model (CDM) [@hripcsak2015observational;@Overhage2012]. A standardized framework
applying current best practices for comparative effectiveness studies within the
OHDSI setting has been proposed [@Ryan2013]. This framework was implemented on a
large scale for estimation of average effects of all first-line hypertension
treatment classes on a total of 52 outcomes of interest across a global network
of 9 observational databases [@Suchard2019].

Treatment effects can often vary substantially across individual patients,
causing overall effect estimates to be inaccurate for a significant proportion
of the patients at hand [@Rothwell1995;@KRAVITZ2004]. Understanding
heterogeneity of treatment effects (HTE) has been central to the agenda for both
personalized (or precision) medicine and comparative effectiveness research,
giving rise to a wide range of approaches for its discovery, evaluation and
application in clinical practice. While exploratory and confirmatory HTE
analyses focus on generating and testing hypotheses on subgroup effects,
predictive HTE analyses use all available patient data to predict the benefits
or harms of treatment in individual patients [@Varadhan2013;@Kent2018].

Baseline risk has been recognized as a robust predictor of treatment effect,
because of the inherent relationship between baseline risk and the absolute
effects of treatment
[@Rothwell2005;@Hayward2006;@Kent2007;@Kent2008;@Kent2010]. For example, an
invasive coronary procedure – in comparison with medical treatment – improves
survival in patients with myocardial infarction at high (predicted) baseline
risk but not in those at low baseline risk [@Thune2005]. It has also been shown
that high-risk patients with pre-diabetes benefit substantially more from a
lifestyle modification program than low-risk patients [@Sussman2015].

Recently, systematic guidance on the application of risk-based methods has been
developed for RCT data [@Kent2019;@PathEnE]. Patients are divided into risk strata using
either an existing or an internally developed risk prediction
model. Risk-stratum-specific estimates provide an overview of the evolution of
treatment effects with increasing risk both on the relative and the absolute
scale. Several methods for predictive HTE analysis have been adapted for use in
observational data, but risk-based methods for predictive HTE in observational
data are still lacking and have been highlighted as an important future research
need [@PathEnE].

We aimed to develop a framework for risk-based assessment of treatment effect
heterogeneity in observational healthcare databases, extending the existing
methodology developed for the RCT setting. We implemented the framework in a
publicly available package providing an out-of-the-box solution for implementing
such analyses at scale within any observational database mapped to OMOP-CDM. In
a case study we analyzed heterogeneity of the effects of first-line hypertension
treatment: we compared the effect of angiotensin converting enzyme (ACE)
inhibitors to beta blockers on 9 outcomes across three different US claims
databases.

# Methods

The proposed framework defines 5 distinct steps that enable a standardized
approach for risk-based assessment of treatment effect heterogeneity for
databases mapped to the OMOP-CDM. These are: 1) general definition of the
research aim; 2) identification of the databases within which the analyses will
be performed; 3) a prediction step where internal or external prediction models
are used to assign patient-level risk predictions; 4) an estimation step where
absolute and relative treatment effects are estimated within risk strata; 5)
presentation of the results. We developed an open-source R-package for the
implementation of the proposed framework and made it publicly available. The
source code can be found at https://github.com/OHDSI/RiskStratifiedEstimation.

## Step 1: General definition of the research aim

The typical research aim is: “to compare the effect of treatment to a comparator
treatment in patients with disease with respect to outcomes $O_1,\dots,O_n$”.

Our framework uses a comparative cohort design. This means that at least 3
cohorts of patients need to be defined at this stage of the framework:

- A single treatment cohort ($T$) which includes patients with disease receiving
  the target treatment of interest.
- A single comparator cohort ($C$) which includes patients with disease receiving
  the comparator treatment.
- One or more outcome cohorts ($O_1,\dots,O_n$) that contain patients
  developing the outcomes of interest
  
## Step 2: Identification of the databases {#methods2}

Including in our analyses multiple databases representing the population of
interest potentially increases the generalizability of results. Furthermore, the
cohorts should preferably have adequate sample size with adequate follow-up time
to ensure precise effect estimation, even within smaller risk strata. Other
issues that may be of importance for database inclusion are the depth of data
capture (the precision at which measurements, lab tests, conditions are
recorded) and the reliability of data entry.

## Step 3: Prediction {#methods3}

We adopt the standardized framework for the generation of patient-level
prediction models using observational data that ensures adherence to existing
guidelines [@Collins2015;@Moons2015]. To generate the target cohort (i.e. the
set of patients on which the prediction model will be developed), we pool the
already defined treatment cohort and comparator cohort. To avoid deferentially
fitting the prediction model to patients across treatment arms, thus introducing
spurious interactions with treatment [@Burke2014;@vanKlaveren2019], we develop
the patient-level prediction model in the propensity score-matched (1:1) subset
of the sample. Finally, we need to define the time horizon within which we aim
to make predictions and we also need to select the machine-learning algorithm we
want to use to generate patient-level predictions.

After model development, a performance overview of the derived prediction models
including discrimination and calibration both in the propensity score matched
subset, the entire sample and separately for treated and comparator patients
should also be reported.

## Step 4: Estimation {#methods4}

We estimate treatment effects (both on the relative and the absolute scale)
within risk strata—typically 4 risk quarters—defined using the prediction model
of step 3. Effect estimation may be focused on the difference in outcomes for a
randomly selected person from the risk stratum (average treatment effect) or for
a randomly selected person from the treatment cohort within the risk stratum
receiving the treatment under study (average treatment effect on the treated).

Any appropriate method for the analysis of relative and absolute treatment
effects can be considered, as long as the this is done consistently in all risk
strata. Common statistical metrics are odds ratios or hazard ratios for relative
scale estimates and differences in observed proportions or differences in
Kaplan-Meier estimates for absolute scale estimates, depending on the problem at
hand. We estimate propensity scores within risk strata which we then use to
match patients from different treatment cohorts or to stratify them into groups
with similar propensity scores or to weigh each patient’s contribution to the
estimation process [@Austin2011].

Prior to analyzing the results, we need to assess if adequate covariate balance
was achieved within each risk stratum accounting for measured
confounding. Common approaches include analysis of the overlap of propensity
score distributions and calculation of standardized mean differences of the
covariates before and after propensity score adjustment.

A schematic overview of the prediction and estimation steps is presented in
Figure XX.

## Step 5: Presentation of results {#methods5}

In the presence of a positive treatment effect and a well-discriminating
prediction model we expect an increasing pattern of the differences in the
absolute scale, even if treatment effects remain constant on the relative scale
across risk strata. Due to this scale-dependence of treatment effect
heterogeneity, results should be assessed both on the relative and the absolute
scale. We find that a side-by-side presentation on a forest-like format can give
a very good representation of our results.

## Case study

As a demonstration of our framework, we evaluated if our proposed method was
able to identify treatment effect heterogeneity of ACE inhibitors compared to
beta blockers using acute myocardial infarction (MI) risk quarter specific
effect estimates, both on the relative and on the absolute scale. We focused on
3 efficacy outcomes (acute MI, hospitalization with heart failure and ischemic
or hemorrhagic stroke) and 6 safety outcomes (hypokalemia, hyperkalemia,
hypotension, angioedema, cough and abnormal weight gain). We used data from 3
US-based claims databases. The analysis plan was the framework outlined in
steps 1 through 5.

A recent meta-analysis has shown that beta-blockers are on average less
efficacious in preventing cardiovascular events than ACE inhibitors
[@Wiysonge2017]. However, meta-analyses focusing on age of the patients have
shown that beta blockers have similar efficacy in younger hypertensive patients,
but should not be used as first-line treatment of hypertension in older patients
mainly due to their increased risk of cardiovascular events compared to other
first-line antihypertensive treatments [@Khan2006;@Vgele2017].Our aim was to
replicate these conclusions in our analyses.

# Results

## Step 1: General definition of the research aim

We considered the following research aim: “compare the effect of ACE-inhibitors
($T$) to the effect of beta blockers ($C$) in patients with established hypertension
with respect to 9 outcomes ($O_1,\dots,O_9$)”. The cohorts are:

- Treatment cohort: Patients receiving any drug within the ACE-inhibitor class
  with at least one year of follow-up before treatment initiation and a recorded
  hypertension diagnosis within that year.
- Comparator cohort: Patients receiving any drug within the beta blocker class
  with at least one year of follow-up before treatment initiation and a recorded
  hypertension diagnosis within that year.
- Outcome cohorts: We considered 3 efficacy and 6 safety outcome cohorts. These
  were patients in the database with a diagnosis of: acute MI; hospitalization
  with heart failure; ischemic or hemorrhagic stroke (efficacy outcomes);
  hypokalemia; hyperkalemia; hypotension; angioedema; cough; abnormal weight
  gain (safety outcomes).

All cohort definitions were identical to the ones used in the multinational
study that provided overall treatment effect estimates comparing all
anti-hypertensive drug classes with each other [@Suchard2019]. More information
can be found in the supplementary material.

## Step 2: Identification of the databases

For our analyses we used data from 3 US claims databases, namely IBM MarketScan
Commercial Claims and Encounters (CCAE), IBM MarketScan Medicaid (MDCD), and IBM
MarketScan Medicare Supplemental Beneficiaries (MDCR). Our analyses included a
total of 784,561, 66,820 and 101,661 patients initiating treatment with ACE
inhibitors and 395,740, 45,999 and 69,798 patients initiating treatment with
beta blockers in CCAE, MDCD and MDCR respectively (Table 1). Adequate numbers of
patients were included in all strata of predicted acute MI risk.

## Step 3: Prediction

We internally developed separate prediction models for acute MI in all 3
databases. The prediction models were estimated on the propensity score matched
(1:1) subset of the sample, using caliper of 0.2 and after excluding patients
having the outcome any time prior to treatment initiation. We chose a time
horizon of 2 years after inclusion into the target cohort. We developed the
prediction models using LASSO logistic regression with 3-fold cross validation
for hyper-parameter selection.

The models developed in the 3 databases had moderate discriminative performance
(internally validated) with no major issues of overfitting to any cohort except
for the case of CCAE database in which the derived prediction model performed
better in the comparator cohort (Table 2). We also observed lower performance of
the prediction model developed in MDCR compared to the other 2 databases (see
supplementary material).

## Step 4: Estimation

Our aim was to estimate the average treatment effects on the relative and the
absolute scale within strata of predicted acute MI risk.

We used patient-level predictions to stratify the sample into 4 MI risk
quarters. Within risk quarters, relative effects were estimated using Cox
regression and absolute effects were estimated from the Kaplan-Meier estimate
differences at 2 years after treatment initiation. To adjust for observed
confounding within risk strata, we estimated propensity scores using the same
approach as in the development of prediction models. We used the estimated
propensity scores to stratify patients into 5 strata, within each risk
quarter. The risk quarter-specific effect estimates were derived by averaging
over the estimates within the propensity score fifths.

There was sufficient overlap of propensity score distribution in all risk strata
(Figure 2). Propensity score adjustment achieved balance for most of the
considered covariates, measured using standardized mean differences before and
after adjustment (Figure 3). However, in lower risk strata imbalances persisted
for a substantial subset of the covariates, all related to pregnancy
findings. This was anticipated (use of ACE inhibitors is specifically
contraindicated during pregnancy) and was already pointed out in
[@Suchard2019]. Therefore, treatment effect estimates in the lowest risk
quarters of CCAE and MDCR may still be subject to residual confounding and
should be interpreted with care.

## Step 5: Presentation of results

```{r, echo=FALSE}
map_outcomes <- readRDS(here("data/processed/multipleRseeAnalyses/map_outcomes.rds"))
map_exposures <- readRDS(here("data/processed/multipleRseeAnalyses/map_exposures.rds"))
relative <- readRDS(here("data/processed/multipleRseeAnalyses/mappedOverallRelativeResults.rds")) %>%
  left_join(map_outcomes, by = c("estOutcome" = "outcome_id")) %>%
  select(-estOutcome) %>%
  rename("estOutcome" = "outcome_name") %>%
  left_join(map_outcomes, by = c("stratOutcome" = "outcome_id")) %>%
  select(-stratOutcome) %>%
  rename("stratOutcome" = "outcome_name") %>%
  left_join(map_exposures, by = c("treatment" = "exposure_id")) %>%
  select(-treatment) %>%
  rename("treatment" = "exposure_name") %>%
  left_join(map_exposures, by = c("comparator" = "exposure_id")) %>%
  select(-comparator) %>%
  rename("comparator" = "exposure_name")

absolute <- readRDS(here("data/processed/multipleRseeAnalyses/mappedOverallAbsoluteResults.rds")) %>%
  left_join(map_outcomes, by = c("estOutcome" = "outcome_id")) %>%
  select(-estOutcome) %>%
  rename("estOutcome" = "outcome_name") %>%
  left_join(map_outcomes, by = c("stratOutcome" = "outcome_id")) %>%
  select(-stratOutcome) %>%
  rename("stratOutcome" = "outcome_name") %>%
  left_join(map_exposures, by = c("treatment" = "exposure_id")) %>%
  select(-treatment) %>%
  rename("treatment" = "exposure_name") %>%
  left_join(map_exposures, by = c("comparator" = "exposure_id")) %>%
  select(-comparator) %>%
  rename("comparator" = "exposure_name") %>%
  mutate(
    estimate = 100 * estimate,
    lower    = 100 * lower,
    upper    = 100 * upper
  )
  

acute_mi_relative <- relative %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "acute_myocardial_infarction"
  )

acute_mi_absolute <- absolute %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "acute_myocardial_infarction"
  )
acute_cough_relative <- relative %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "cough"
  )

acute_cough_absolute <- absolute %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "cough"
  )
```

For hospitalization with acute MI there was an increasing trend in favor ACE
inhibitors compared to beta blockers on the relative scale (hazard ratios
decreased) with increasing acute MI risk. More specifically, hazard ratios
decreased from 
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) and
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) to
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`;
95\% CI),
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`;
95\% CI) in CCAE and MDCD respectively (Figure 4). In MDCR hazard ratios remained stable
from
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) in the lowest MI risk quarter to 
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`;
95\% CI). In terms of hospitalization with heart failure relative treatment
effect estimates favored ACE inhibitors across all risk strata in all
databases. We found no differences between the two treatments in their effect on
stroke on the relative scale. In terms of the safety outcomes, we found an
increased ACE-inhibitor risk of cough and angioedema on the relative scale
across all risk strata. In the case of cough, this effect decreased with
increasing risk of acute MI---from 
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`;
95\% CI),
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`;
95\% CI), and
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) to
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`;
95\% CI),
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`;
95\% CI), and
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`;
95\% CI) in CCAE, MDCD, and MDCR, respectively.

We observed an increasing trend of treatment effect on the absolute scale with
increasing acute MI risk in favor of ACE inhibitors in terms of acute MI in all
databases except for MDCR---from
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI), 
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI), and
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI) in the lowest acute MI risk quarter to
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI),
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI), and
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI) in the highest acute MI risk quarter in CCAE, MDCD, and MDCR,
respectively (Figure 5). We found no difference on the absolute scale for stroke
across risk strata. Absolute risk differences did not favor ACE inhibitors
compared to beta blockers in terms of cough, even though this effect again
diminished with increasing acute MI risk---from 
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI),
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI), and
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI) in the lowest acute MI risk quarter to
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI),
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI), and
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI) in the highest acute MI risk quarter in CCAE, MDCD, and MDCR,
respectively. In terms of angioedema absolute risk differences were very small
due to the rarity of the outcome.

The results of all the analyses performed can be accessed and assessed through a
publicly available web application (https://data.ohdsi.org/AceBeta9Outcomes).

## Evaluation

Meta-analyses focusing on the age of the patients have found that beta blockers
could only be considered as a first-line treatment for hypertension in younger
patients, in whom risk of cardiovascular events is lower. The results of our
case study are in line with this evidence, suggesting that treatment with
ACE-inhibitors, compared to treatment with beta blockers, may be focused on the
higher risk patients, in whom the benefits outweigh the harms, while beta
blockers may be a viable option in lower risk patients, in whom the benefit-harm
tradeoff is more favorable. Our case study however, was carried out as
demonstration of the framework and more rigorous analyses are required to make
any suggestions for clinical practice.

# Discussion

The major contribution of our work is the development of a risk-based framework
for the assessment of treatment effect heterogeneity in large observational
databases. This fills a gap identified in the literature after the development
of guidelines for performing such analyses in the RCT setting
[@Kent2019;@PathEnE]. As an additional contribution we developed the software
for implementing this framework in practice and made it publicly available. We
made our software compatible to databases mapped to OMOP-CDM which allows
researchers to easily implement our framework in a global network of healthcare
databases. In our case study we demonstrated the use of our framework for the
evaluation of treatment effect heterogeneity ACE-inhibitors compared to beta
blockers on 3 efficacy and 6 safety outcomes. Our results were in line with the
findings of relevant literature focusing on the age of patients treated for
hypertension. We propose that this framework is implemented any time treatment
effect estimation in high-dimensional observational data is undertaken.

In recent years several methods for the analysis of treatment effect
heterogeneity have been developed in the setting of RCTs [@Rekkas2020]. However,
low power and restricted prior knowledge on the mechanisms of variation in
treatment effect are often inherent in RCTs, which are usually adequately
powered only for the analysis of the primary outcome. Observational databases
contain a large amount of information on treatment assignment and outcomes of
interest, while also capturing key patient characteristics. They contain readily
available data on patient subpopulations of interest for which no RCT has
focused before either due to logistical or ethical reasons. However,
observational databases are usually not built with research in mind and
therefore are susceptible to biases, poorly measured outcomes and
missingness. All these can both obscure true treatment effect heterogeneity or
falsely introduce it when there is none [@Varadhan2013]. Therefore, inferences
on both overall treatment effect estimates and treatment effect heterogeneity
need to rely on strong, often unverifiable, assumptions, despite the
advancements and guidance on best practices. However, it has been shown that
well-designed observational studies on average replicate RCT results, even
though often differences in magnitude may occur
[@Concato2000;@Ioannidis2001;@Dahabreh2012@Anglemyer2014;@Franklin2017]. Our
framework is in line with the recently suggested paradigm of high-throughput
observational studies using consistent and standardized methods for improving
reproducibility in observational research [@Schuemie2018].

We attempt to account for potential confounding by estimating propensity scores
within strata of predicted risk. These scores are estimated using regularized
logistic regression on a large set of pre-defined covariates. However, such
approaches do not account for unobserved confounding. Several sensitivity
analyses have been proposed in the literature for measuring the robustness of
results in the presence of unobserved confounding
[@Liu2013;@Cinelli2019]. Another approach is to calibrate estimates and
confidence intervals based on a large set of negative controls
[@Schuemie2014;@Schuemie2571]. Negative controls are treatment-outcome pairs for
which a null effect has been established. Estimating these effects within
available data provides an approximation of the null distribution that can be
used to empirically recalibrate effect estimates. Future work may extend our
framework with this type of analyses.

Ideally, externally derived and adequately validated prediction models would be
preferred for analyzing treatment effect heterogeneity. In the absence of such
prediction models an internally-developed risk prediction model can be
considered. Earlier simulations of RCT studies have shown that internal models
developed on the combined treatment and control arms blinded to treatment gave
relatively unbiased estimates of treatment effect across the spectrum of risk
[@Burke2014]. However, in observational databases treatment arms may significantly
differ in sample size. Because the prediction model will possibly fit better to
the larger treatment arm, spurious treatment-covariate interactions may be
introduced in the prediction model, leading to sub-optimal risk
stratification. As a remedy, we first match the patients in the treatment and
the comparator cohorts on the basis of propensity scores. Additionally, we
propose to assess model performance in the separate treatment arms to evaluate
its aptness for risk stratification. Other methods for achieving covariate
balance before fitting the prediction model can be considered. For example,
weighting on the propensity scores would be another valid approach.

Disease risk scores have been explored as an alternative to propensity scores
for balancing covariates [@Glynn2012;@Hansen2008]. In our method, the objective
of risk stratification is not balancing, but assessing the variation of
treatment effects on multiple outcomes across patients with different levels of
baseline risk. Although using the same risk model for balancing and risk-based
HTE analysis may sound attractive, we note that our method only uses one risk
model for stratification and one propensity score model for balancing, while
separate disease risk score models would be required to analyze treatment
effects for each of the multiple outcomes.


\newpage
# References
\nolinenumbers
\setlength{\parindent}{-0.25in}
\setlength{\leftskip}{0.25in}
\noindent
<div id="refs"></div>
\setlength{\parindent}{0in}
\setlength{\leftskip}{0in}
\noindent
