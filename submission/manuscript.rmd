---
title: "A standardized framework for risk-based assessment of treatment effect heterogeneity in observational healthcare databases"
author: 
  - Alexandros Rekkas, MSc${^1}$ 
  - David van Klaveren, PhD$^{2,3}$, 
  - Patrick B. Ryan, PhD$^4$
  - Ewout W. Steyerberg, PhD$^{3,5}$
  - David M. Kent, MD$^2$
  - Peter R. Rijnbeek, PhD${^1}$
output:
    bookdown::pdf_document2:
      number_sections: false
      keep_tex: true
    bookdown::word_document2:
        reference_docx: reference.docx
geometry: margin=1.0in
toc: false
font-size: 11pt
header-includes:
  - \renewcommand*\familydefault{\sfdefault}
  - \usepackage{setspace}
  - \doublespacing
  - \usepackage[left, pagewise]{lineno}
  - \usepackage[labelfont=bf]{caption}
editor_options: 
  chunk_output_type: console
bibliography: references.bib
csl: the-lancet.csl
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(here)
library(kableExtra)
d <- function(x, decimals = 2) {
  sprintf(paste0("%1.", decimals, "f"), x) 
}
inline_hook <- function(x) {
  if (is.numeric(x)) {
    if (abs(x - round(x)) < .Machine$double.eps) {
      formatted <- format(x, digits = 1, big.mark = ",")
    } else {
      formatted <- format(x, digits = 1, nsmall = 2, big.mark = ",", decimal.mark = ".")
    }
  } else {
    formatted <- x
  }
  
  return(formatted)
}

knit_hooks$set(inline = inline_hook)
```
\thispagestyle{empty}

$^1$ Department of Medical Informatics, Erasmus University Medical Center,
Rotterdam, Netherlands

$^2$ Predictive Analytics and Comparative Effectiveness (PACE) Center, Institute
for Clinical Research and Health Policy Studies (ICRHPS), Tufts Medical Center,
Boston, MA, USA

$^3$ Department of Public Health, Erasmus University Medical Center, Rotterdam,
Netherlands

$^4$ Janssen Research and Development, 125 Trenton Harbourton Rd,
Titusville,NJ 08560, USA

$^5$ Department of Biomedical Data Sciences, Leiden University Medical Center,
Leiden, The Netherlands


\vspace{10mm}
**Corresponding author**
\singlespacing 
Alexandros Rekkas, MSc

Department of Medical Informatics

Erasmus University Medical Center

3000 CA Rotterdam, P.O. Box 2040

Email: a.rekkas@erasmusmc.nl
\onehalfspacing

\vspace{10mm}
**Funding**

This work has been performed in the European Health Data and
Evidence Network (EHDEN) project. This project has received funding from the
Innovative Medicines Initiative 2 Joint Undertaking (JU) under grant agreement
No 806968. The JU receives support from the European Union’s Horizon 2020
research and innovation programme and EFPIA.

\newpage
\newpage
# Abstract {-}
\singlespacing 
Treatment effects are often anticipated to vary across groups of patients with
different baseline risk. The Predictive Approaches to Treatment Effect
Heterogeneity (PATH) statement focused on baseline risk as a robust predictor of
treatment effect and provided guidance on risk-based assessment of treatment
effect heterogeneity in the RCT setting. The aim of this study was to extend
this approach to the observational setting using a standardised scalable
framework. The proposed framework consists of five steps: 1) definition of the
research aim, i.e., the population, the treatment, the comparator and the
outcome(s) of interest; 2) identification of relevant databases; 3) development
of a prediction model for the outcome(s) of interest; 4) estimation of relative
and absolute treatment effect within strata of predicted risk, after adjusting
for observed confounding; 5) presentation of the results. We demonstrate our
framework by evaluating heterogeneity of the effect of angiotensin-converting
enzyme (ACE) inhibitors versus beta blockers on three efficacy and six safety
outcomes across three observational databases.  The proposed framework can
supplement any comparative effectiveness study. We provide a publicly available
R software package for applying this framework to any database mapped to the
Observational Medical Outcomes Partnership Common Data Model. In our
demonstration, patients at low risk of acute myocardial infarction received
negligible absolute benefits for all three efficacy outcomes, though they were
more pronounced in the highest risk quarter, especially for hospitalisation with
heart failure. However, failing diagnostics showed evidence of residual
imbalances even after adjustment for observed confounding. Our framework allows
for the evaluation of differential treatment effects across risk strata, which
offers the opportunity to consider the benefit-harm trade-off between
alternative treatments. It is easily applicable and highly informative whenever
treatment effect estimation in observational data is of interest.

\vspace{10mm}

**Keywords**: observational data, heterogeneity of treatment effect, risk stratification, subgroup analysis
\newpage 
\doublespacing 
\linenumbers

# INTRODUCTION

Treatment effects can often vary substantially across individual patients,
causing overall effect estimates to be inaccurate for a significant proportion
of the patients at hand [@Rothwell1995;@KRAVITZ2004]. Understanding
heterogeneity of treatment effects (HTE) has been crucial for both personalized
(or precision) medicine and comparative effectiveness research, giving rise to a
wide range of approaches for its discovery, evaluation and application in
clinical practice. A common approach to evaluating HTE in clinical trials is
through subgroup analyses, which are rarely adequately powered and can lead to
false conclusions of absence of HTE or exaggerate its presence
[@Hayward2006;@Kent2018]. In addition, patients differ with regard to multiple
characteristics simulatneously, resulting in much richer HTE compared to the one
explored with regular on-variable-at-a-time subgroup analyses [Kent, BMJ 2018].

Baseline risk is a summary score inherently related to treatment effect that
can represent more closely the variability in patient characteristics
[@Rothwell2005;@Hayward2006;@Kent2007;@Kent2008;@Kent2010]. For example, an
invasive coronary procedure---in comparison with medical treatment---improves
survival in patients with myocardial infarction at high (predicted) baseline
risk but not in those at low baseline risk [@Thune2005]. It has also been shown
that high-risk patients with pre-diabetes benefit substantially more from a
lifestyle modification program than low-risk patients [@Sussman2015].

Recently, systematic guidance on the application of risk-based methods for the
assessment of HTE has been developed for RCT data [@Kent2019;@PathEnE]. After
risk-stratifying patients using an existing or an internally derived prediction
model, risk stratum-specific estimates of relative and absolute treatment effect
are evaluated. Several methods for predictive HTE analysis have been adapted for
use in observational data, but risk-based methods are still not readily
available and have been highlighted as an important future research need
[@PathEnE].

The Observational Health Data Science and Informatics (OHDSI) collaborative has
established a global network of data partners and researchers that aim to bring
out the value of health data through large-scale analytics by mapping local
databases to the Observational Medical Outcomes Partnership (OMOP) Common Data
Model (CDM) [@hripcsak2015observational;@Overhage2012]. A standardized framework
applying current best practices for comparative effectiveness studies within the
OHDSI setting has been proposed [@Ryan2013]. This framework was successfully
implemented on a large scale for estimation of average effects of all first-line
hypertension treatment classes on a total of 52 outcomes of interest across a
global network of nine observational databases [@Suchard2019].

We aimed to develop a framework for risk-based assessment of treatment effect
heterogeneity in observational healthcare databases, extending the existing
methodology developed for the RCT setting. We implemented the framework in a
publicly available package providing an out-of-the-box solution for implementing
such analyses at scale within any observational database mapped to OMOP-CDM. In
a case study we analyzed heterogeneity of the effects of first-line hypertension
treatment.


# RESULTS
The proposed framework defines 5 distinct steps: 1) definition of the research
aim; 2) identification of the databases within which the analyses will be
performed; 3) prediction of outcomes of interest; 4) estimation of absolute and
relative treatment effects within risk strata; 5) presentation of the
results. We developed an open-source R-package for the implementation of the
proposed framework and made it publicly available
(https://github.com/OHDSI/RiskStratifiedEstimation). An overview of the entire
framework can be found in Figure \ref{fig:graphicalAbstract}.

```{r graphicalAbstract, cache=TRUE, echo=FALSE, fig.cap="\\textbf{Framework execution diagram}. Illustration of how the framework is applied on two observational databases, preferably mapped to OMOP-CDM.", fig.show="hold", out.width = '100%'}
include_graphics(here("figures/rsee_process.png"))
```

As a demonstration, we evaluated if our proposed method was able to identify
treatment effect heterogeneity of ACE inhibitors compared to beta blockers using
acute myocardial infarction (MI) risk quarter specific effect estimates, both on
the relative and on the absolute scale. We focused on three efficacy outcomes
(acute MI, hospitalization with heart failure and ischemic or hemorrhagic
stroke) and six safety outcomes (hypokalemia, hyperkalemia, hypotension,
angioedema, cough and abnormal weight gain). We used data from three US-based
claims databases. 

## Step 1: General definition of the research aim

We considered the following research aim: “compare the effect  of ACE inhibitors
($T$) to the effect of beta blockers ($C$) in patients with established hypertension
with respect to nine outcomes ($O_1,\dots,O_9$)”. The cohorts are:

- Treatment cohort: Patients receiving any drug within the ACE inhibitor class
  with at least one year of follow-up before treatment initiation and a recorded
  hypertension diagnosis within that year.
- Comparator cohort: Patients receiving any drug within the beta blocker class
  with at least one year of follow-up before treatment initiation and a recorded
  hypertension diagnosis within that year.
- Outcome cohorts: We considered three efficacy and six safety outcome cohorts. These
  were patients in the database with a diagnosis of: acute MI; hospitalization
  with heart failure; ischemic or hemorrhagic stroke (efficacy outcomes);
  hypokalemia; hyperkalemia; hypotension; angioedema; cough; abnormal weight
  gain (safety outcomes). Among the safety outcomes we focus on angioedema and
  cough which are two known adverse events linked to treatment with ACE
  inhibitors [@Israili1992]. Results on the rest of the safety outcomes
  are included in the supplement.

All cohort definitions were identical to the ones used in the multinational
study that provided overall treatment effect estimates comparing all
anti-hypertensive drug classes with each other [@Suchard2019]. More information
can be found in the supplementary material.

## Step 2: Identification of the databases

```{r, echo = FALSE}
incidenceOverall <- readRDS(here::here("data/processed/incidenceOverall.rds"))
patientNumbers <- incidenceOverall %>%
  group_by(database) %>%
  summarise(
    treatment = max(treatmentPersons),
    comparator = max(comparatorPersons)
  )
```

For our demonstration we used data from three US claims databases, namely IBM
MarketScan Commercial Claims and Encounters (CCAE), IBM MarketScan Medicaid
(MDCD), and IBM MarketScan Medicare Supplemental Beneficiaries (MDCR). Our
analyses included a total of
`r patientNumbers %>% filter(database == "ccae") %>% pull(treatment)`,
`r patientNumbers %>% filter(database == "mdcd") %>% pull(treatment)`, and
`r patientNumbers %>% filter(database == "mdcr") %>% pull(treatment)`
patients initiating treatment with ACE inhibitors and 
`r patientNumbers %>% filter(database == "ccae") %>% pull(comparator)`,
`r patientNumbers %>% filter(database == "mdcd") %>% pull(comparator)`, and
`r patientNumbers %>% filter(database == "mdcr") %>% pull(comparator)`
patients initiating treatment with beta blockers in CCAE, MDCD and MDCR
respectively (Table \@ref(tab:incidenceOverall)). Adequate numbers of patients
were included in all strata of predicted acute MI risk (Supplementary Tables
S1-S3).

```{r incidenceOverall, echo = FALSE}
map_outcomes <- readRDS(here("data/processed/map_outcomes.rds"))
map_exposures <- readRDS(here("data/processed/map_exposures.rds"))

incidence <- readRDS(here::here("data/processed/incidenceOverall.rds")) %>%
  left_join(map_outcomes, by = c("outcomeId" = "outcome_id")) %>%
  select(-outcomeId) %>%
  rename("outcomeId" = "outcome_name") %>%
  mutate(
    treatmentYears = round(treatmentDays / 365),
    comparatorYears = round(comparatorDays / 365),
    outcomeId =  factor(
    outcomeId,
    levels = c(
      "acute_myocardial_infarction",
      "hospitalization_with_heart_failure",
      "stroke"
    ),
    labels = c(
        "acute myocardial infarction",
        "hospitalization with heart failure",
        "stroke"
      )
    )
  ) %>%
  arrange(database, outcomeId)
  
kableExtra::kbl(
  incidence %>%
    select(
      outcomeId,
      treatmentPersons,
      treatmentYears,
      treatmentOutcomes,
      comparatorPersons,
      comparatorYears,
      comparatorPersons,
      comparatorOutcomes
    ),
  align = "llrrrrr",
  format = "latex",
  booktabs = TRUE,
  longtable = TRUE,
  escape = FALSE,
  caption = "Number of patients, person years and events within quarters of predicted risk for acute MI for the three efficacy outcomes of the study (acute MI, hospitalization with heart failure and ischemic or hemorrhagic stroke) across the three databases.",
  linesep = c('', '', '', '\\addlinespace'),
  col.names = c(
    "Outcome",
    "Patients",
    "Person years",
    "Outcomes",
    "Patients",
    "Person years",
    "Outcomes"
  ),
  format.args = list(
    big.mar      = ",",
    decimal.mark = "."
  )
) %>%
  kableExtra::add_header_above(
    c(
      " " = 1,
      "ACE inhibitors" = 3,
      "Beta blockers" = 3
    )
  ) %>%
  kableExtra::group_rows("CCAE", 1, 3) %>%
  kableExtra::group_rows("MDCD", 4, 6) %>%
  kableExtra::group_rows("MDCR", 7, 9) %>%
  kableExtra::kable_styling(font_size = 7)

```

## Step 3: Prediction

We internally developed separate prediction models for acute MI in all three
databases. The prediction models were estimated on the propensity score matched
(1:1) subset of the sample, using caliper of 
`r format(.2, nsmall = 1, decimal.mark = ".")`
and after excluding patients having the outcome any time prior to treatment
initiation. We chose a 2-year time at risk for patients and developed the
prediction models using LASSO logistic regression with 3-fold cross validation
for hyper-parameter selection.

The models had moderate discriminative performance (internally validated) with
no major issues of overfitting to any cohort except for the case of CCAE, where
the derived prediction model performed better in the comparator cohort (Table
\@ref(tab:predictionPerformance)). We also observed lower performance of the
prediction model developed in MDCR compared to the other 2 databases.

```{r predictionPerformance, echo = FALSE}
predictionPerformance <- readRDS(here("data/processed/predictionPerformance.rds")) %>%
  filter(
    stratOutcome == 2
  ) %>%
  select(c("database", "cohort", "AUROC", "95% lower AUROC", "95% upper AUROC")) %>%
  rename(
    "lower" = "95% lower AUROC",
    "upper" = "95% upper AUROC"
  ) %>%
  mutate(
    auc = paste(
      format(round(AUROC, 2), nsmall = 2), 
      paste0(
        "(",
        format(round(lower, 2), nsmall = 2),
        ", ",
        format(round(upper, 2), nsmall = 2),
        ")"
      )
    )
  ) %>%
  select(-c("AUROC", "lower", "upper")) %>%
  mutate(
    cohort = factor(
      cohort,
      levels = c(
        "Matched",
        "Treatment",
        "Comparator",
        "EntirePopulation"
      ),
      labels = c(
        "Matched",
        "Treatment",
        "Comparator",
        "Entire population"
      )
    ),
    database = factor(
      database,
      levels = c(
        "ccae",
        "mdcd",
        "mdcr"
      )
    )
  ) %>%
  arrange(database, cohort) 

kableExtra::kbl(
  predictionPerformance %>% pivot_wider(id_cols = "cohort", names_from = "database", values_from = "auc"),
  align = "lrrr",
  format = "latex",
  booktabs = TRUE,
  longtable = TRUE,
  escape = FALSE,
  caption = "Discriminative ability (c-statistic) of the derived prediction models for acute myocardial infarction in the matched set (development set), the treatment cohort, the comparator cohort and the entire population in CCAE, MDCD and MDCR.",
  linesep = c('', '', '', '\\addlinespace'),
  col.names = c(
    "Population",
    "CCAE",
    "MDCD",
    "MDCR"
  ),
  format.args = list(
    big.mar      = ","
  )
) %>%
  kableExtra::kable_styling(font_size = 7)
```

## Step 4: Estimation

We used patient-level predictions to stratify the sample into four acute MI risk
quarters. Within risk quarters, relative effects were estimated using Cox
regression and absolute effects were derived from the Kaplan-Meier estimate
differences at two years after treatment initiation. To adjust for observed
confounding within each risk quarter, we estimated propensity scores using the
same approach as step 3 and stratified patients into five propensity score
strata. The risk quarter-specific effect estimates were derived by averaging
over the estimates within the propensity score fifths.

In the lowest acute MI risk quarter of CCAE and MDCD we observed strong
separation of the propensity score distributions, therefore, effect estimates
derived in these strata are not well-supported (Figure
\ref{fig:psDensity}). This problematic behavior is also visible in the covariate
balance plots comparing standardized mean differences of patient characteristics
before and afrer PS adjustment, where in many cases the commonly accepted bound
of 
`r format(.1, nsmall = 1, decimal.mark = ".")`
is violated (Figure \ref{fig:covariateBalance}). This is more pronounced in the
lowest acute MI risk quarter of CCAE, but remains an issue for a small number of
covariates in all CCAE risk strata. This diagnostic also fails for the two lower
acute MI risk quarters of MDCD. Often the persisting imbalances were linked to
pregnancy outcomes, which can be explained by the contraindication of ACE
inhibitors in this condition. Analyses in MDCR passed all diagnostics.

```{r psDensity, cache=TRUE, echo=FALSE, fig.cap="\\textbf{Preference score distributions in quarters of predicted acute MI risk}. The preference score is a transformation of the propensity score that adjusts for prevalence differences between populations. Higher overlap of the preference score distributions indicates that patients in the target and the comparator cohorts are more similar in terms of the predicted probability of receiving treatment (ACE inhibitors).", fig.show="hold", out.width = '100%'}
grid::grid.raster(tiff::readTIFF(here("figures/PsDensity.tiff")))
```

```{r covariateBalance, cache=TRUE, echo=FALSE, fig.cap="\\textbf{Patient characteristic balance for ACE inhibitors and beta blockers before and after stratification on the propensity scores}. Each dot represents the standardized difference of means for a single covariate before (x-axis) and after (y-axis) stratification. A commonly used rule of thumb suggests that standardized mean differences above 0.1 indicate insufficient covariate balance post propensity score adjustment.", fig.show="hold", out.width = '100%'}
grid::grid.raster(tiff::readTIFF(here("figures/CovariateBalance.tiff")))
```

Finally, the distribution of the estimated relative risks with regard to 30
negative control outcomes indicated unresolved confounding within the lowest
acute MI risk quarter of CCAE (Figrue \ref{fig:negativeControls}). Hazard ratios
significantly different than 1 (true effect size) were concentrated in the lower
right part of Figure \ref{fig:negativeControls}: panel Q1. This suggests
significant negative effects of ACE inhibitors compared to beta blockers on
causally unrelated outcomes, pointing at unresolved differences between the two
treatment arms. This was not the case in the other risk quarters of CCAE, or in
any risk quarter of MDCD and MDCR (Supplementary Figures S1-S2).

```{r negativeControls, cache=TRUE, echo=FALSE, fig.cap="\\textbf{Systematic error}. Effect size estimates for the negative controls (true hazard ratio = 1). Estimates below the diagonal dashed lines are statistically significant (alpha = 0.05) different from the true effect size. A well-calibrated estimator should have the true effect size within the 95 percent confidence interval 95 percent of times.", fig.show="hold", out.width = '100%'}
grid::grid.raster(tiff::readTIFF(here("figures/NegativeControlsPlot_ccae.tiff")))
```

## Step 5: Presentation of results

```{r, echo=FALSE}
overall <- readRDS(here("data/processed/mappedOverallResults.rds")) %>%
  left_join(map_outcomes, by = c("outcomeId" = "outcome_id")) %>%
  select(-outcomeId) %>%
  rename("outcome" = "outcome_name") %>%
  left_join(map_exposures, by = c("treatmentId" = "exposure_id")) %>%
  select(-treatmentId) %>%
  rename("treatment" = "exposure_name") %>%
  left_join(map_exposures, by = c("comparatorId" = "exposure_id")) %>%
  select(-comparatorId) %>%
  rename("comparator" = "exposure_name") %>%
  mutate(
    outcome = gsub("_", " ", outcome),
    estimate = paste0(
      format(round(estimate, 2), nsmall = 2),
      " (", 
      format(round(lower, 2), nsmall = 2),
      ", ", 
      format(round(upper, 2), nsmall = 2),
      ")"
    )
  ) %>%
  select(-c("treatment", "comparator", "analysisType", "seLogRr", "lower", "upper")) %>%
  relocate(c("database", "outcome"))

relative <- readRDS(here("data/processed/mappedOverallRelativeResults.rds")) %>%
  left_join(map_outcomes, by = c("estOutcome" = "outcome_id")) %>%
  select(-estOutcome) %>%
  rename("estOutcome" = "outcome_name") %>%
  left_join(map_outcomes, by = c("stratOutcome" = "outcome_id")) %>%
  select(-stratOutcome) %>%
  rename("stratOutcome" = "outcome_name") %>%
  left_join(map_exposures, by = c("treatment" = "exposure_id")) %>%
  select(-treatment) %>%
  rename("treatment" = "exposure_name") %>%
  left_join(map_exposures, by = c("comparator" = "exposure_id")) %>%
  select(-comparator) %>%
  rename("comparator" = "exposure_name")

absolute <- readRDS(here("data/processed/mappedOverallAbsoluteResults.rds")) %>%
  left_join(map_outcomes, by = c("estOutcome" = "outcome_id")) %>%
  select(-estOutcome) %>%
  rename("estOutcome" = "outcome_name") %>%
  left_join(map_outcomes, by = c("stratOutcome" = "outcome_id")) %>%
  select(-stratOutcome) %>%
  rename("stratOutcome" = "outcome_name") %>%
  left_join(map_exposures, by = c("treatment" = "exposure_id")) %>%
  select(-treatment) %>%
  rename("treatment" = "exposure_name") %>%
  left_join(map_exposures, by = c("comparator" = "exposure_id")) %>%
  select(-comparator) %>%
  rename("comparator" = "exposure_name") %>%
  mutate(
    estimate = 100 * estimate,
    lower    = 100 * lower,
    upper    = 100 * upper
  )
  

acute_mi_relative <- relative %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "acute_myocardial_infarction"
  )

acute_mi_absolute <- absolute %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "acute_myocardial_infarction"
  )
acute_cough_relative <- relative %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "cough"
  )

acute_cough_absolute <- absolute %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "cough"
  )
    
acute_mi_stroke_relative <- relative %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "stroke"
  )

acute_mi_stroke_absolute <- absolute %>%
  filter(
    stratOutcome == "acute_myocardial_infarction",
    estOutcome == "stroke"
  )
```

The overall estimated hazard ratios for the main outcomes are presented in
Table \@ref(tab:overallTable). For hospitalization with acute MI there was an increasing trend in
favor ACE inhibitors compared to beta blockers on the relative scale (hazard
ratios decreased) with increasing acute MI risk. More specifically, hazard
ratios decreased from
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) and
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) to
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`;
95\% CI),
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`;
95\% CI) in CCAE and MDCD respectively (Figure \ref{fig:relative}). In MDCR hazard ratios
increased from
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) in the lowest MI risk quarter to 
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)` to
`r acute_mi_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`;
95\% CI). Relative treatment effect estimates for hospitalization with heart
failure favored ACE inhibitors across all risk strata in all databases. In the
case of stroke in CCAE we found quite constant hazard ratios which became weaker
in the highest risk quarter patients
(`r acute_mi_stroke_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`
with 95\% CI from 
`r acute_mi_stroke_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)`
to
`r acute_mi_stroke_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`).
In the other two databases no significant relative treatment effects were
observed for stroke.  In terms of the safety outcomes, we found an increased ACE inhibitor
risk of cough and angioedema on the relative scale across all risk strata. In
the case of cough, this effect decreased with increasing risk of acute MI---from
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`;
95\% CI),
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`;
95\% CI), and
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`;
95\% CI) to
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`;
95\% CI),
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`;
95\% CI), and
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`
(`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)` to
`r acute_cough_relative %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`;
95\% CI) in CCAE, MDCD, and MDCR, respectively.

```{r overallTable, echo = FALSE}
kableExtra::kbl(
  overall %>% 
    pivot_wider(id_cols = "outcome", names_from = "database", values_from = "estimate"),
  format = "latex",
  align = "lrrr",
  caption = "Overall hazard ratios.",
  booktabs = TRUE,
  col.names = c(
    "Outcome",
    "CCAE",
    "MDCD",
    "MDCR"
  )) %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

```{r relative, cache=TRUE, echo=FALSE, fig.cap="\\textbf{Overview of heterogeneity of ACE inhibitors treatment on the relative scale (hazard ratios) within strata of predicted risk of acute MI}. Values below 1 favor ACE inhibitors, while values above 1 favor beta blockers.", fig.show="hold", out.width = '100%'}
    grid::grid.raster(tiff::readTIFF(here("figures/CombinedRelative_acute_myocardial_infarction.tiff")))
```

We observed an increasing trend of treatment effect on the absolute scale with
increasing acute MI risk in favor of ACE inhibitors in terms of acute MI in all
databases except for MDCR---from
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI), 
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI), and
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI) in the lowest acute MI risk quarter to
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI),
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI), and
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_mi_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI) in the highest acute MI risk quarter in CCAE, MDCD, and MDCR,
respectively (Figure \ref{fig:absolute}). We found no difference on the absolute
scale for stroke across risk strata. Absolute risk differences did not favor ACE
inhibitors compared to beta blockers in terms of cough, even though this effect
again diminished with increasing acute MI risk---from
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI),
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI), and
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q1") %>% pull(upper)`\%;
95\% CI) in the lowest acute MI risk quarter to
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "ccae", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI),
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcd", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI), and
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(estimate)`\%
(`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(lower)`\% to
`r acute_cough_absolute %>% filter(database == "mdcr", riskStratum == "Q4") %>% pull(upper)`\%;
95\% CI) in the highest acute MI risk quarter in CCAE, MDCD, and MDCR,
respectively. In terms of angioedema absolute risk differences were very small
due to the rarity of the outcome.

```{r absolute, cache=TRUE, echo=FALSE, fig.cap="\\textbf{Overview of heterogeneity of ACE inhibitors treatment on the absolute scale within strata of predicted risk of acute MI}. Estimates of absolute treatment effect are derived as the difference in Kaplan-Meier estimates at two years after inclusion. Values above 0 favor ACE inhibitors, while values below 0 favor beta blockers.  ", fig.show="hold", out.width = '100%'}
grid::grid.raster(tiff::readTIFF(here("figures/CombinedAbsolute_acute_myocardial_infarction.tiff")))
```

The results of all the analyses performed can be accessed and assessed through a
publicly available web application (https://data.ohdsi.org/AceBeta9Outcomes).

## Interpretation

The overall benefits of ACE inhibitors compared to beta blockers for acute MI
and hospitalization with heart failure are driven mainly by the higher acute MI
risk patients in CCAE and MDCD, hence the observed increasing patterns of the
absolute treatment benefits. In MDCR we found no significant overall difference
on the relative scale for acute MI and, cosequently, no differences in acute MI
risk strata were observed on any scale. For heart failure, MDCR patients at the
lower half of acute MI risk had lower absolute benefits compared to the patients
at the upper half. Finally, the small overall relative effect for stroke
resulted in smaller absolute benefits of ACE inhibitors across acute MI risk
strata in all databases.

For patients at lower acute MI risk, the cough and angioedema risk increase
related to treatment with ACE inhibitors may be important factors to consider
for medical decision making, given the small benefits observed for the main
outcomes. However, diagnostics failed in lower risk patients within CCAE and
MDCR which renders these conclusions less dependable.

Note that any conclusions drawn are for demonstration purposes only and should
be interpreted under this very limited setting.

# DISCUSSION

The major contribution of our work is the development of a risk-based framework
for the assessment of treatment effect heterogeneity in large observational
databases. This fills a gap identified in the literature after the development
of guidelines for performing such analyses in the RCT setting
[@Kent2019;@PathEnE]. As an additional contribution we developed the software
for implementing this framework in practice and made it publicly available. We
made our software compatible to databases mapped to OMOP-CDM which allows
researchers to easily implement our framework in a global network of healthcare
databases. In our case study we demonstrated the use of our framework for the
evaluation of treatment effect heterogeneity ACE inhibitors compared to beta
blockers on three efficacy and six safety outcomes. We propose that this framework is
implemented any time treatment effect estimation in high-dimensional
observational data is undertaken.

In recent years several methods for the analysis of treatment effect
heterogeneity have been developed in the RCT setting [@Rekkas2020]. However,
low power and restricted prior knowledge on the mechanisms of variation in
treatment effect are often inherent in RCTs, which are usually adequately
powered only for the analysis of the primary outcome. Observational databases
contain a large amount of information on treatment assignment and outcomes of
interest, while also capturing key patient characteristics. They contain readily
available data on patient subpopulations of interest for which no RCT has
focused before either due to logistical or ethical reasons. However,
observational databases can be susceptible to biases, poorly measured outcomes
and missingness, which may obscure true HTE or falsely introduce it when there
is none [@Varadhan2013]. Therefore, inferences on both overall treatment effect
estimates and HTE need to rely on strong, often unverifiable, assumptions,
despite the advancements and guidance on best practices. However, well-designed
observational studies on average replicate RCT results, even though often
differences in magnitude may occur
[@Concato2000;@Ioannidis2001;@Dahabreh2012@Anglemyer2014;@Franklin2017]. Our
framework is in line with the recently suggested paradigm of high-throughput
observational studies using consistent and standardized methods for improving
reproducibility in observational research [@Schuemie2018].

Our framework highlights the scale dependency of HTE and how it relates to
baseline risk. Treatment effect is mathematically determined by baseline
risk, if we assume a constant non-zero effect size [@Dahabreh2016]. Patients
with low baseline risk can only experience minimal benefits, before their risk
is reduced to zero. In contrast, high risk patients are capable of displaying
much higher absolute benefits. This becomes evident when evaluating the effects
of ACE inhibitors on cough and angioedema, compared to treatment with beta
blockers. Despite the small relative cough risk increase of ACE inhibitors, the
large baseline cough risk resulted in larger absolute risk differences, compared
to the other considered outcomes. Conversely, in the case of angioedema, the
substantial relative risk increase with ACE inhibitors only translated in a
small absolute risk increase due to the quite low baseline angioedema risk.

The application of our framework in the case study is for demonstration purposes
and there are several limitations to its conclusions. First, death could be a
competing risk. We could expand our framework in the future to potentially
support subdistribution hazard ratios and cumulative incidence
reductions. Second, we only used the databases readily available to us and not
all the available databases mapped to OMOP-CDM. Therefore, the generalizability
of our results still needs to be explored in future studies. These studies
should also address the particular aspects of the databases at hand, such as
their sampling frame, the completeness of the data they capture and many others
that were not assessed in our demonstration. Third, we did not to correct for
multiplicity when presenting the results. We are interested in presenting trends
in the data and not detecting the specific subgroups within which a non-null
treatment effect is detected. The implementation of our framework, however,
generates all the relevant output required for a researcher to correct for
multiple testing, if that is required.

In conclusion, the case study demonstrates the feasibility of our framework for
risk-based assessment of treatment effect heterogeneity in large observational
data. It is easily applicable and highly informative whenever treatment effect
estimation in high-dimensional observational data is of interest.

# METHODS


## Step 1: General definition of the research aim

The typical research aim is: “to compare the effect of treatment to a comparator
treatment in patients with disease with respect to outcomes $O_1,\dots,O_n$”.

We use a comparative cohort design. This means that at least three cohorts of
patients need to be defined at this stage of the framework:

- A single treatment cohort ($T$) which includes patients with disease receiving
  the target treatment of interest.
- A single comparator cohort ($C$) which includes patients with disease receiving
  the comparator treatment.
- One or more outcome cohorts ($O_1,\dots,O_n$) that contain patients
  developing the outcomes of interest
  
## Step 2: Identification of the databases {#methods2}

Including in our analyses multiple databases representing the population of
interest potentially increases the generalizability of results. Furthermore, the
cohorts should preferably have adequate sample size with adequate follow-up time
to ensure precise effect estimation, even within smaller risk strata. Other
relevant issues such as the depth of data capture (the precision at which
measurements, lab tests, conditions are recorded) and the reliability of data
entry should also be considered.

## Step 3: Prediction {#methods3}

Our method relies on adequately separating patients into subgroups based on
their baseline risk for the outcomes of interest. Therefore, a model---either an
existing external model adequately validated on an internally developed
one---assigning patient-level risk is required. For internally developing a risk
prediction model we adopt the standardized framework focused on observational
data that ensures adherence to existing guidelines [@Reps2018; @Collins2015;
@Moons2015].

We first need to define a target cohort of patients, i.e. the set of patients on
whom the prediction model will be developed. In our case, the target cohort is
generated by pooling the already defined treatment and comparator cohorts. We
develop the prediction model on the propensity score-matched (1:1) subset of the
pooled sample to avoid differentially fitting between treatment arms, thus
introducing spurious interactions with treatment
[@Burke2014;@vanKlaveren2019]. We also need to define a set of patients that
experience the outcome of interest, i.e. the outcome cohort. Finally, we need to
decide the time frame within which the predictions will be carried out, i.e. the
patients' time at risk. Subsequently, we can develop the prediction model. 

It is important that the prediction models display good discriminative ability
to ensure that risk-based subgroups are accurately defined. A performance
overview of the derived prediction models including discrimination and
calibration both in the propensity score matched subset, the entire sample and
separately for treated and comparator patients should also be reported.

## Step 4: Estimation {#methods4}

We estimate treatment effects (both on the relative and the absolute scale)
within risk strata defined using the prediction model of step 3. We often
consider four risk strata, but fewer or more strata can be considered depending on
the available power for accurately estimating stratum-specific treatment
effects. Effect estimation may be focused on the difference in outcomes for a
randomly selected person from the risk stratum (average treatment effect) or for
a randomly selected person from the treatment cohort within the risk stratum
receiving the treatment under study (average treatment effect on the treated).

Any appropriate method for the analysis of relative and absolute treatment
effects can be considered, as long as the this is done consistently in all risk
strata. Common statistical metrics are odds ratios or hazard ratios for relative
scale estimates and differences in observed proportions or differences in
Kaplan-Meier estimates for absolute scale estimates, depending on the problem at
hand. We estimate propensity scores within risk strata which we then use to
match patients from different treatment cohorts or to stratify them into groups
with similar propensity scores or to weigh each patient’s contribution to the
estimation process [@Austin2011].

Prior to analyzing results, it is crucial to ensure that all diagnostics are passed
in all risk strata. The standard diagnostics we carry out include analysis of
the overlap of propensity score distributions and calculation of standardized
mean differences of the covariates before and after propensity score
adjustment. Finally, we use effect estimates for a large set of negative control
outcomes (i.e. outcomes known to not be related with any of the exposures under
study) to evaluate the presence of residual confounding not accounted for by
propensity score adjustment [@Schuemie2014;@Schuemie2571;@Schuemie2018].

## Step 5: Presentation of results {#methods5}

In the presence of a positive treatment effect and a well-discriminating
prediction model we expect an increasing pattern of the differences in the
absolute scale, even if treatment effects remain constant on the relative scale
across risk strata. Due to this scale-dependence of treatment effect
heterogeneity, results should be assessed both on the relative and the absolute
scale. 

# DATA AVAILABILITY
The claims data are proprietary and are not publicly accessible due to
restricted user agreement. Database descriptions are available in the
Supplementary Material.

# CODE AVAILABILITY
The source code for the R-package that implements our framework can be found at
https://github.com/OHDSI/RiskStratifiedEstimation. The code for implementing the
proof of concept study presented here is publicly available at
https://github.com/mi-erasmusmc/AceBeta9Outcomes.


\newpage
# REFERENCES
\nolinenumbers
\setlength{\parindent}{-0.25in}
\setlength{\leftskip}{0.25in}
\noindent
<div id="refs"></div>
\setlength{\parindent}{0in}
\setlength{\leftskip}{0in}
\noindent

\newpage

# ACKNOWLEDGEMENTS
AR and PRR have received funding from the Innovative Medicines Initiative 2
Joint Undertaking (JU) under grant agreement No 80696. The JU receives support
from the European Union’s Horizon 2020 research and innovation programme and
EFPIA.

# AUTHOR CONTRIBUTIONS
AR, PRR, and DVK conceptualised the study. AR, DVK, EWS, and DMK developed the
methodology. PBR, and PRR acquired the data and AR analysed the data. AR
developed the software and wrote drafted the manuscript, which was critically
reviewed by DVK, PBR, EWS, DMK, and PRR. AR, PBR, and PRR had full access to the
raw data. All authors read and approved the manuscript and had final
responsibility for the decision to submit for publication.

# COMPETING INTERESTS
AR and PRR work for a group that received unconditional research grants from
Boehringer-Ingelheim, GSK, Janssen Research & Development, Novartis, Pfizer,
Yamanouchi, and Servier. None of these grants result in a conflict of interest
for the content of this paper. PBR is an employee of Janssen R&D, subsidiary of
Johnson & Johnson. DVK, DMK, EWS have nothing to declare.
